/*! behaviors.js is part of Webrecorder project. Copyright (C) 2021, Webrecorder Software. Licensed under the Affero General Public License v3. */(()=>{"use strict";let t=console.log;function e(t){return new Promise((e=>setTimeout(e,t)))}async function i(t,i){for(;!t();)await e(i)}function s(){return new Promise((t=>{"complete"===document.readyState?t():window.addEventListener("load",t)}))}function a(e,i="debug"){t&&t({msg:JSON.stringify(e),type:i})}function r(e){t=e}class o{constructor(t,e){this.matchValue=l(t,e)}async restore(t,i){let s=null;for(;s=h(t),!s;)await e(100);return h(i.replace("$1",this.matchValue),s)}}class n{constructor(t){this.loc=window.location.href,t()}get changed(){return window.location.href!==this.loc}goBack(t){if(!this.changed)return Promise.resolve(!0);const e=h(t);return new Promise(((t,i)=>{window.addEventListener("popstate",(e=>{t()}),{once:!0}),e?e.click():window.history.back()}))}}function h(t,e){return e=e||document,document.evaluate(t,e,null,XPathResult.FIRST_ORDERED_NODE_TYPE).singleNodeValue}function l(t,e){return e=e||document,document.evaluate(t,e,null,XPathResult.STRING_TYPE).stringValue}class c{constructor(){this._running=null,this.paused=null,this._unpause=null}start(){this._running=this.run()}done(){return this._running?this._running:Promise.resolve()}async run(){for await(const t of this)a(t,"info"),this.paused&&await this.paused;a({msg:"done!"},"info")}pause(){this.paused||(this.paused=new Promise((t=>{this._unpause=t})))}unpause(){this._unpause&&(this._unpause(),this.paused=null,this._unpause=null)}}const d=/\s*(\S*\s+[\d.]+[wx]),|(?:\s*,(?:\s+|(?=https?:)))/,u=/(url\s*\(\s*[\\"']*)([^)'"]+)([\\"']*\s*\))/gi,w=/(@import\s*[\\"']*)([^)'";]+)([\\"']*\s*;?)/gi;class m{constructor(){this.urlSet=new Set,this.urlqueue=[],this.numPending=0,this.start()}async start(){await s(),this.run(),this.initObserver()}done(){return Promise.resolve()}async run(){this.extractSrcSrcSetAll(document),this.extractStyleSheets()}isValidUrl(t){return t&&(t.startsWith("http:")||t.startsWith("https:"))}queueUrl(t){try{t=new URL(t,document.baseURI).href}catch(t){return}this.isValidUrl(t)&&(this.urlSet.has(t)||(this.urlSet.add(t),this.doFetch(t)))}async doFetch(t){if(this.urlqueue.push(t),this.numPending<=6)for(;this.urlqueue.length>0;){const t=this.urlqueue.shift();try{this.numPending++,a("AutoFetching: "+t);const e=await fetch(t);await e.blob()}catch(t){a(t)}this.numPending--}}initObserver(){this.mutobz=new MutationObserver((t=>this.observeChange(t))),this.mutobz.observe(document.documentElement,{characterData:!1,characterDataOldValue:!1,attributes:!0,attributeOldValue:!0,subtree:!0,childList:!0,attributeFilter:["srcset"]})}processChangedNode(t){switch(t.nodeType){case Node.ATTRIBUTE_NODE:"srcset"===t.nodeName&&this.extractSrcSetAttr(t.nodeValue);break;case Node.TEXT_NODE:t.parentNode&&"STYLE"===t.parentNode.tagName&&this.extractStyleText(t.nodeValue);break;case Node.ELEMENT_NODE:t.sheet&&this.extractStyleSheet(t.sheet),this.extractSrcSrcSet(t),setTimeout((()=>this.extractSrcSrcSetAll(t)),1e3)}}observeChange(t){for(const e of t)if(this.processChangedNode(e.target),"childList"===e.type)for(const t of e.addedNodes)this.processChangedNode(t)}extractSrcSrcSetAll(t){const e=t.querySelectorAll("img[srcset], img[data-srcset], img[data-src], video[srcset], video[data-srcset], video[data-src], audio[srcset], audio[data-srcset], audio[data-src], picture > source[srcset], picture > source[data-srcset], picture > source[data-src], video > source[srcset], video > source[data-srcset], video > source[data-src], audio > source[srcset], audio > source[data-srcset], audio > source[data-src]");for(const t of e)this.extractSrcSrcSet(t)}extractSrcSrcSet(t){if(!t||t.nodeType!==Node.ELEMENT_NODE)return void console.warn("No elem to extract from");const e=t.src||t.getAttribute("data-src");e&&this.queueUrl(e);const i=t.srcset||t.getAttribute("data-srcset");i&&this.extractSrcSetAttr(i)}extractSrcSetAttr(t){for(const e of t.split(d))if(e){const t=e.trim().split(" ");this.queueUrl(t[0])}}extractStyleSheets(t){t=t||document;for(const e of t.styleSheets)this.extractStyleSheet(e)}extractStyleSheet(t){let e;try{e=t.cssRules||t.rules}catch(t){return void a("Can't access stylesheet")}for(const t of e)t.type===CSSRule.MEDIA_RULE&&this.extractStyleText(t.cssText)}extractStyleText(t){const e=(t,e,i,s)=>(this.queueUrl(i),e+i+s);t.replace(u,e).replace(w,e)}}class f{constructor(){this.mediaSet=new Set,this.promises=[],this.promises.push(new Promise((t=>this._initDone=t))),this.start()}async start(){await s(),this.initObserver();for(const[t,e]of document.querySelectorAll("video, audio").entries())this.addMediaWait(e);await e(1e3),this._initDone()}initObserver(){this.mutobz=new MutationObserver((t=>this.observeChange(t))),this.mutobz.observe(document.documentElement,{characterData:!1,characterDataOldValue:!1,attributes:!1,attributeOldValue:!1,subtree:!0,childList:!0})}observeChange(t){for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)t instanceof HTMLMediaElement&&this.addMediaWait(t)}addMediaWait(t){if(a("media: "+t.outerHTML),(t.src&&t.src.startsWith("http:")||t.src.startsWith("https:"))&&!this.mediaSet.has(t.src))return a("fetch media URL: "+t.src),this.mediaSet.add(t.src),void this.promises.push(fetch(t.src).then((t=>t.blob())));if(t.play){let e;const i=new Promise((t=>{e=t}));this.promises.push(i),t.addEventListener("loadstart",(()=>a("loadstart"))),t.addEventListener("loadeddata",(()=>a("loadeddata"))),t.addEventListener("playing",(()=>{a("playing"),e()})),t.addEventListener("ended",(()=>{a("ended"),e()})),t.addEventListener("paused",(()=>{a("paused"),e()})),t.addEventListener("error",(()=>{a("error"),e()})),t.paused&&(a("generic play event for: "+t.outerHTML),t.muted=!0,t.click(),t.play())}}done(){return Promise.allSettled(this.promises)}}class p extends c{static get name(){return"Autoscroll"}async*[Symbol.asyncIterator](){const t={top:250,left:0,behavior:"auto"};for(;self.scrollY+self.innerHeight<Math.max(self.document.body.scrollHeight,self.document.body.offsetHeight,self.document.documentElement.clientHeight,self.document.documentElement.scrollHeight,self.document.documentElement.offsetHeight);)self.scrollBy(t),yield{msg:"Scrolling by "+t.top},await e(500)}}class g extends c{static isMatch(){return window.location.href.match(/https:\/\/(www\.)?instagram\.com\/\w[\w]+/)}static get name(){return"Instagram"}constructor(){super(),this.state={},this.rootPath="//article/div/div",this.childMatchSelect="string(.//a[starts-with(@href, '/')]/@href)",this.childMatch="child::div[.//a[@href='$1']]",this.firstPostInRow="div[1]/a",this.postCloseButton='//button[.//*[@aria-label="Close"]]',this.nextPost="//div[@role='dialog']//a[text()='Next']",this.postLoading="//*[@aria-label='Loading...']",this.subpostNextOnlyChevron="//article[@role='presentation']//div[@role='presentation']/following-sibling::button",this.subpostPrevNextChevron=this.subpostNextOnlyChevron+"[2]",this.commentRoot="//article/div[3]/div[1]/ul",this.viewReplies="li//button[span[contains(text(), 'View replies')]]",this.loadMore="//button[span[@aria-label='Load more comments']]",this.scrollOpts={block:"start",inline:"nearest",behavior:"smooth"}}async waitForNext(t){return t?(await e(100),t.nextElementSibling?t.nextElementSibling:null):null}async*iterRow(){let t=h(this.rootPath);if(!t)return;let i=t.firstElementChild;if(i)for(;i;){await e(100);const t=new o(this.childMatchSelect,i);t.matchValue&&(yield i,i=await t.restore(this.rootPath,this.childMatch)),i=await this.waitForNext(i)}}async viewFirstPost(){let t=h(this.rootPath);if(!t||!t.firstElementChild)return;const e=l(this.childMatchSelect,t.firstElementChild),s=window.location.href;window.history.replaceState({},"",e),window.dispatchEvent(new PopStateEvent("popstate",{state:{}}));let a=null,r=null;await i((()=>(a=h(this.rootPath))!==t&&a),1e3),window.history.replaceState({},"",s),window.dispatchEvent(new PopStateEvent("popstate",{state:{}})),await i((()=>(r=h(this.rootPath))!==a&&r),1e3)}async*iterSubposts(){let t=h(this.subpostNextOnlyChevron);for(yield this.state;t;)t.click(),await e(1e3),t=h(this.subpostPrevNextChevron);await e(1e3)}async iterComments(){let t=h(this.commentRoot).firstElementChild;for(;t;){let i;for(t.scrollIntoView(this.scrollOpts);null!==(i=h(this.viewReplies,t));)i.click(),await e(500);if(t.nextElementSibling&&"LI"===t.nextElementSibling.tagName){let i=h(this.loadMore,t.nextElementSibling);i&&(i.click(),await e(1e3))}t=t.nextElementSibling,await e(500)}}async*iterPosts(t){let i=0;for(;t&&++i<=3;)for(t.click(),await e(1e3),await fetch(window.location.href),yield*this.iterSubposts(),await Promise.race([this.iterComments(),e(2e4)]),t=h(this.nextPost);!t&&h(this.postLoading);)await e(500);await e(1e3)}async*[Symbol.asyncIterator](){await this.viewFirstPost();for await(const t of this.iterRow()){t.scrollIntoView(this.scrollOpts),await e(500);const i=h(this.firstPostInRow,t);yield*this.iterPosts(i);const s=h(this.postCloseButton);s&&s.click(),await e(1e3)}}}class y extends c{static isMatch(){return window.location.href.match(/https:\/\/(www\.)?twitter\.com\//)}static get name(){return"Twitter"}constructor(t=1){super(),this.maxDepth=t||0,this.rootPath="//div[starts-with(@aria-label, 'Timeline')]/*[1]",this.anchorQuery=".//article",this.childMatchSelect="string(.//article//a[starts-with(@href, '/') and @aria-label]/@href)",this.childMatch="child::div[.//a[@href='$1']]",this.expandQuery=".//div[@role='button' and @aria-haspopup='false']//*[contains(text(), 'more repl')]",this.quoteQuery=".//div[@role='blockquote' and @aria-haspopup='false']",this.imageQuery=".//a[@role='link' and @aria-haspopup='false' and starts-with(@href, '/') and contains(@href, '/photo/')]",this.imageNextQuery="//div[@aria-label='Next']",this.imageCloseQuery="//div[@aria-label='Close' and @role='button']",this.backButtonQuery="//div[@aria-label='Back' and @role='button']",this.progressQuery=".//*[@role='progressbar']",this.promoted='.//*[text()="Promoted"]',this.seenTweets=new Set,this.seenMediaTweets=new Set,this.state={videos:0,images:0,threadsOrReplies:0,viewedFully:0}}getState(t,e){return e&&null!=this.state[e]&&this.state[e]++,{state:this.state,msg:t}}async waitForNext(t){if(!t)return null;if(await e(100),!t.nextElementSibling)return null;for(;h(this.progressQuery,t.nextElementSibling);)await e(100);return t.nextElementSibling}async expandMore(t){const i=h(this.expandQuery,t);if(!i)return t;const s=t.previousElementSibling;for(i.click(),await e(100);h(this.progressQuery,s.nextElementSibling);)await e(100);return t=s.nextElementSibling}async*infScroll(){let t=h(this.rootPath);if(!t)return;let i=t.firstElementChild;if(i)for(;i;){let t=h(this.anchorQuery,i);if(!t&&this.expandQuery&&(i=await this.expandMore(i,this.expandQuery,this.progressQuery),t=h(this.anchorQuery,i)),i&&i.innerText&&i.scrollIntoView(),i&&t){await e(100);const s=new o(this.childMatchSelect,i);s.matchValue&&(yield t,i=await s.restore(this.rootPath,this.childMatch))}i=await this.waitForNext(i,this.progressQuery)}}async*mediaPlaying(t){const i=h("(.//video | .//audio)",t);if(!i||i.paused)return;let s="Waiting for media playback ";try{const e=new URL(l(this.childMatchSelect,t.parentElement),window.location.origin).href;if(this.seenMediaTweets.has(e))return;s+="for "+e,this.seenMediaTweets.add(e)}catch(t){console.warn(t)}s+="to finish...",yield this.getState(s,"videos");const a=new Promise((t=>{i.addEventListener("ended",(()=>t())),i.addEventListener("abort",(()=>t())),i.addEventListener("error",(()=>t())),i.addEventListener("pause",(()=>t()))}));await Promise.race([a,e(6e4)])}async*iterTimeline(t=0){if(!this.seenTweets.has(window.location.href)){yield this.getState("Capturing thread/timeline: "+window.location.href);for await(const i of this.infScroll()){if(h(this.promoted,i))continue;await e(1e3);const s=h(this.imageQuery,i);if(s){const t=new n((()=>s.click()));yield this.getState("Loading Image: "+window.location.href,"images"),await e(1e3);let i=null,a=window.location.href;for(;null!=(i=h(this.imageNextQuery));){if(i.click(),await e(400),window.location.href===a){await e(1e3);break}a=window.location.href,yield this.getState("Loading Image: "+window.location.href,"images"),await e(1e3)}await t.goBack(this.imageCloseQuery)}const a=h(this.quoteQuery,i);if(a){const i=new n((()=>a.click()));await e(100),yield this.getState("Capturing Quote: "+window.location.href),!this.seenTweets.has(window.location.href)&&t<this.maxDepth&&(yield*this.iterTimeline(t+1,this.maxDepth),this.seenTweets.add(window.location.href)),await e(2e3),await i.goBack(this.backButtonQuery),await e(1e3)}yield*this.mediaPlaying(i);const r=new n((()=>i.click()));await e(200),r.changed&&(yield this.getState("Capturing Tweet: "+window.location.href),!this.seenTweets.has(window.location.href)&&t<this.maxDepth&&(yield*this.iterTimeline(t+1,this.maxDepth),this.seenTweets.add(window.location.href)),await e(500),await r.goBack(this.backButtonQuery)),0===t?this.state.viewedFully++:this.state.threadsOrReplies++,await e(1e3)}}}async*[Symbol.asyncIterator](){yield*this.iterTimeline(0)}}const v=[g,y];self.__bx_behaviors=new class{constructor(){this.behaviors=[],this.mainBehavior=null,this.inited=!1,a("Loaded behaviors for: "+self.location.href)}init(t={autofetch:!0,autoplay:!0,autoscroll:!0,siteSpecific:!0}){if(this.inited)return;if(this.inited=!0,!self.window)return;if(this.timeout=t.timeout,void 0!==t.log){let e=t.log;"string"==typeof e&&(e=self[e]),"function"==typeof e?r(e):!1===e&&r(null)}t.autofetch&&(a("Enable AutoFetcher"),this.behaviors.push(new m)),t.autoplay&&(a("Enable Autoplay"),this.behaviors.push(new f));let e=!1;if(self.window.top===self.window){if(t.siteSpecific)for(const t of v)if(t.isMatch()){a("Starting Site-Specific Behavior: "+t.name),this.mainBehaviorClass=t,this.mainBehavior=new t,e=!0;break}!e&&t.autoscroll&&(a("Starting Autoscroll"),this.mainBehaviorClass=p,this.mainBehavior=new p),this.mainBehavior&&this.behaviors.push(this.mainBehavior)}}async run(t){this.init(t),await s(),this.mainBehavior&&this.mainBehavior.start();let i=Promise.allSettled(this.behaviors.map((t=>t.done())));this.timeout?(a(`Waiting for behaviors to finish or ${this.timeout}ms timeout`),i=Promise.race([i,e(this.timeout)])):a("Waiting for behaviors to finish"),await i,a("All Behaviors Done!")}pause(){a("Pausing Main Behavior"+this.mainBehaviorClass.name),this.mainBehavior&&this.mainBehavior.pause()}unpause(){a("Unpausing Main Behavior: "+this.mainBehaviorClass.name),this.mainBehavior&&this.mainBehavior.unpause()}}})();