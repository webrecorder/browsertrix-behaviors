/*! behaviors.js is part of Webrecorder project. Copyright (C) 2021, Webrecorder Software. Licensed under the Affero General Public License v3. */(()=>{"use strict";let t=console.log,e=null;const i=200;function s(t){return new Promise((e=>setTimeout(e,t)))}async function a(t,e){for(;!t();)await s(e)}function o(){return new Promise((t=>{"complete"===document.readyState?t():window.addEventListener("load",t)}))}function n(e,i="debug"){if(t)try{t({data:e,type:i})}catch(s){t(JSON.stringify({data:e,type:i}))}}function r(e){t=e}function l(t){t.__bx_behaviors=new e}class h{constructor(t,e){this.matchValue=u(t,e)}async restore(t,e){let i=null;for(;i=d(t),!i;)await s(100);return d(e.replace("$1",this.matchValue),i)}}class c{constructor(t){this.loc=window.location.href,t()}get changed(){return window.location.href!==this.loc}goBack(t){if(!this.changed)return Promise.resolve(!0);const e=d(t);return new Promise((t=>{window.addEventListener("popstate",(()=>{t()}),{once:!0}),e?e.click():window.history.back()}))}}function d(t,e){return e=e||document,document.evaluate(t,e,null,XPathResult.FIRST_ORDERED_NODE_TYPE).singleNodeValue}function u(t,e){return e=e||document,document.evaluate(t,e,null,XPathResult.STRING_TYPE).stringValue}class m{constructor(){this._running=null,this.paused=null,this._unpause=null,this.state={}}start(){this._running=this.run()}done(){return this._running?this._running:Promise.resolve()}async run(){try{for await(const t of this)n(t,"info"),this.paused&&await this.paused;n(this.getState("done!"),"info")}catch(t){n(this.getState(t),"info")}}pause(){this.paused||(this.paused=new Promise((t=>{this._unpause=t})))}unpause(){this._unpause&&(this._unpause(),this.paused=null,this._unpause=null)}getState(t,e){return e&&void 0!==this.state[e]&&this.state[e]++,{state:this.state,msg:t}}cleanup(){}}const w=/\s*(\S*\s+[\d.]+[wx]),|(?:\s*,(?:\s+|(?=https?:)))/,f=/(url\s*\(\s*[\\"']*)([^)'"]+)([\\"']*\s*\))/gi,p=/(@import\s*[\\"']*)([^)'";]+)([\\"']*\s*;?)/gi;class g{constructor(){this.urlSet=new Set,this.urlqueue=[],this.numPending=0,this.start()}async start(){await o(),this.run(),this.initObserver()}done(){return Promise.resolve()}async run(){this.extractSrcSrcSetAll(document),this.extractStyleSheets()}isValidUrl(t){return t&&(t.startsWith("http:")||t.startsWith("https:"))}queueUrl(t){try{t=new URL(t,document.baseURI).href}catch(t){return}this.isValidUrl(t)&&(this.urlSet.has(t)||(this.urlSet.add(t),this.doFetch(t)))}async doFetch(t){if(this.urlqueue.push(t),this.numPending<=6)for(;this.urlqueue.length>0;){const t=this.urlqueue.shift();try{this.numPending++,n("AutoFetching: "+t);const e=await fetch(t);await e.blob()}catch(t){n(t)}this.numPending--}}initObserver(){this.mutobz=new MutationObserver((t=>this.observeChange(t))),this.mutobz.observe(document.documentElement,{characterData:!1,characterDataOldValue:!1,attributes:!0,attributeOldValue:!0,subtree:!0,childList:!0,attributeFilter:["srcset"]})}processChangedNode(t){switch(t.nodeType){case Node.ATTRIBUTE_NODE:"srcset"===t.nodeName&&this.extractSrcSetAttr(t.nodeValue);break;case Node.TEXT_NODE:t.parentNode&&"STYLE"===t.parentNode.tagName&&this.extractStyleText(t.nodeValue);break;case Node.ELEMENT_NODE:t.sheet&&this.extractStyleSheet(t.sheet),this.extractSrcSrcSet(t),setTimeout((()=>this.extractSrcSrcSetAll(t)),1e3)}}observeChange(t){for(const e of t)if(this.processChangedNode(e.target),"childList"===e.type)for(const t of e.addedNodes)this.processChangedNode(t)}extractSrcSrcSetAll(t){const e=t.querySelectorAll("img[srcset], img[data-srcset], img[data-src], video[srcset], video[data-srcset], video[data-src], audio[srcset], audio[data-srcset], audio[data-src], picture > source[srcset], picture > source[data-srcset], picture > source[data-src], video > source[srcset], video > source[data-srcset], video > source[data-src], audio > source[srcset], audio > source[data-srcset], audio > source[data-src]");for(const t of e)this.extractSrcSrcSet(t)}extractSrcSrcSet(t){if(!t||t.nodeType!==Node.ELEMENT_NODE)return void console.warn("No elem to extract from");const e=t.src||t.getAttribute("data-src");e&&this.queueUrl(e);const i=t.srcset||t.getAttribute("data-srcset");i&&this.extractSrcSetAttr(i)}extractSrcSetAttr(t){for(const e of t.split(w))if(e){const t=e.trim().split(" ");this.queueUrl(t[0])}}extractStyleSheets(t){t=t||document;for(const e of t.styleSheets)this.extractStyleSheet(e)}extractStyleSheet(t){let e;try{e=t.cssRules||t.rules}catch(t){return void n("Can't access stylesheet")}for(const t of e)t.type===CSSRule.MEDIA_RULE&&this.extractStyleText(t.cssText)}extractStyleText(t){const e=(t,e,i,s)=>(this.queueUrl(i),e+i+s);t.replace(f,e).replace(p,e)}}class y{constructor(){this.mediaSet=new Set,this.promises=[],this.promises.push(new Promise((t=>this._initDone=t))),this.start()}async start(){await o(),this.initObserver();for(const[,t]of document.querySelectorAll("video, audio").entries())this.addMediaWait(t);await s(1e3),this._initDone()}initObserver(){this.mutobz=new MutationObserver((t=>this.observeChange(t))),this.mutobz.observe(document.documentElement,{characterData:!1,characterDataOldValue:!1,attributes:!1,attributeOldValue:!1,subtree:!0,childList:!0})}observeChange(t){for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)t instanceof HTMLMediaElement&&this.addMediaWait(t)}addMediaWait(t){if(n("media: "+t.outerHTML),(t.src&&t.src.startsWith("http:")||t.src.startsWith("https:"))&&!this.mediaSet.has(t.src))return n("fetch media URL: "+t.src),this.mediaSet.add(t.src),void this.promises.push(fetch(t.src).then((t=>t.blob())));if(t.play){let e;const i=new Promise((t=>{e=t}));this.promises.push(i),t.addEventListener("loadstart",(()=>n("loadstart"))),t.addEventListener("loadeddata",(()=>n("loadeddata"))),t.addEventListener("playing",(()=>{n("playing"),e()})),t.addEventListener("ended",(()=>{n("ended"),e()})),t.addEventListener("paused",(()=>{n("paused"),e()})),t.addEventListener("error",(()=>{n("error"),e()})),t.paused&&(n("generic play event for: "+t.outerHTML),t.muted=!0,t.click(),t.play())}}done(){return Promise.allSettled(this.promises)}}class S extends m{constructor(){super(),this.showMoreQuery="//*[contains(text(), 'show more') or contains(text(), 'Show more')]",this.state={segments:1}}static get name(){return"Autoscroll"}async*[Symbol.asyncIterator](){const t=()=>self.scrollY+self.innerHeight<Math.max(self.document.body.scrollHeight,self.document.body.offsetHeight,self.document.documentElement.clientHeight,self.document.documentElement.scrollHeight,self.document.documentElement.offsetHeight),e={top:200,left:0,behavior:"auto"};let o=null,n=self.document.body.clientHeight;for(;t();)self.document.body.clientHeight>n&&this.state.segments++,n=self.document.body.clientHeight,o||(o=d(this.showMoreQuery)),o&&(r=void 0,(r=o.getBoundingClientRect()).top>=0&&r.left>=0&&r.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&r.right<=(window.innerWidth||document.documentElement.clientWidth))&&(yield this.getState("Clicking 'Show More', awaiting more content"),o.click(),await s(i),await Promise.race([a((()=>self.document.body.clientHeight>n),500),s(3e4)]),o=null),self.scrollBy(e),yield this.getState(`Scrolling down by ${e.top} pixels every 0.2 seconds`),await s(200),await Promise.race([a((()=>t()),200),s(5e3*this.state.segments)]);var r}}class v extends m{static isMatch(){return window.location.href.match(/https:\/\/(www\.)?instagram\.com\/\w[\w]+/)}static get name(){return"Instagram"}constructor(){super(),this.state={},this.rootPath="//article/div/div",this.childMatchSelect="string(.//a[starts-with(@href, '/')]/@href)",this.childMatch="child::div[.//a[@href='$1']]",this.firstPostInRow="div[1]/a",this.postCloseButton='//button[.//*[@aria-label="Close"]]',this.nextPost="//div[@role='dialog']//a[text()='Next']",this.postLoading="//*[@aria-label='Loading...']",this.subpostNextOnlyChevron="//article[@role='presentation']//div[@role='presentation']/following-sibling::button",this.subpostPrevNextChevron=this.subpostNextOnlyChevron+"[2]",this.commentRoot="//article/div[3]/div[1]/ul",this.viewReplies="li//button[span[contains(text(), 'View replies')]]",this.loadMore="//button[span[@aria-label='Load more comments']]",this.scrollOpts={block:"start",inline:"nearest",behavior:"smooth"},this.maxCommentsTime=1e4,this.postOnlyWindow=null,this.state={posts:0,slides:0,rows:0,comments:0}}cleanup(){this.postOnlyWindow&&(this.postOnlyWindow.close(),this.postOnlyWindow=null)}async waitForNext(t){return t?(await s(i),t.nextElementSibling?t.nextElementSibling:null):null}async*iterRow(){let t=d(this.rootPath);if(!t)return;let e=t.firstElementChild;if(e)for(;e;){await s(i);const t=new h(this.childMatchSelect,e);t.matchValue&&(yield e,e=await t.restore(this.rootPath,this.childMatch)),e=await this.waitForNext(e)}}async*viewStandalonePost(t){let e=d(this.rootPath);if(!e||!e.firstElementChild)return;const i=u(this.childMatchSelect,e.firstElementChild);yield this.getState("Loading single post view for first post: "+i);{window.history.replaceState({},"",i),window.dispatchEvent(new PopStateEvent("popstate",{state:{}})),yield this.getState("Loading post page via first post: "+i);let o=null,n=null;await s(2e3),await a((()=>(o=d(this.rootPath))!==e&&o),1e3),window.history.replaceState({},"",t),window.dispatchEvent(new PopStateEvent("popstate",{state:{}})),await s(2e3),await a((()=>(n=d(this.rootPath))!==o&&n),1e3)}}async*iterSubposts(){let t=d(this.subpostNextOnlyChevron),e=1;for(;t;)t.click(),await s(1e3),yield this.getState(`Loading Slide ${++e} for ${window.location.href}`,"slides"),t=d(this.subpostPrevNextChevron);await s(1e3)}async iterComments(){const t=d(this.commentRoot);if(!t)return;let e=t.firstElementChild,i=!1;for(;e;){let t;for(e.scrollIntoView(this.scrollOpts),i=!0;null!==(t=d(this.viewReplies,e));)t.click(),this.state.comments++,await s(500);if(e.nextElementSibling&&"LI"===e.nextElementSibling.tagName){let t=d(this.loadMore,e.nextElementSibling);t&&(t.click(),this.state.comments++,await s(1e3))}e=e.nextElementSibling,await s(500)}return i}async*iterPosts(t){let e=0;for(;t&&++e<=3;)for(t.click(),await s(2e3),yield this.getState("Loading Post: "+window.location.href,"posts"),await fetch(window.location.href),yield*this.iterSubposts(),yield this.getState("Loaded Comments","comments"),await Promise.race([this.iterComments(),s(this.maxCommentsTime)]),t=d(this.nextPost);!t&&d(this.postLoading);)await s(500);await s(1e3)}async*[Symbol.asyncIterator](){const t=window.location.href;for await(const t of this.iterRow()){await s(500);d(this.firstPostInRow,t).click(),await s(2e3);break}yield*this.viewStandalonePost(t);for await(const t of this.iterRow()){t.scrollIntoView(this.scrollOpts),await s(500),yield this.getState("Loading Row","rows");const e=d(this.firstPostInRow,t);yield*this.iterPosts(e);const i=d(this.postCloseButton);i&&i.click(),await s(1e3)}}}class b extends m{static isMatch(){return window.location.href.match(/https:\/\/(www\.)?twitter\.com\//)}static get name(){return"Twitter"}constructor(t=0){super(),this.maxDepth=t||0,this.rootPath="//div[starts-with(@aria-label, 'Timeline')]/*[1]",this.anchorQuery=".//article",this.childMatchSelect="string(.//article//a[starts-with(@href, '/') and @aria-label]/@href)",this.childMatch="child::div[.//a[@href='$1']]",this.expandQuery=".//div[@role='button' and @aria-haspopup='false']//*[contains(text(), 'more repl')]",this.quoteQuery=".//div[@role='blockquote' and @aria-haspopup='false']",this.imageQuery=".//a[@role='link' and starts-with(@href, '/') and contains(@href, '/photo/')]",this.imageNextQuery="//div[@aria-label='Next slide']",this.imageCloseQuery="//div[@aria-label='Close' and @role='button']",this.backButtonQuery="//div[@aria-label='Back' and @role='button']",this.progressQuery=".//*[@role='progressbar']",this.promoted='.//*[text()="Promoted"]',this.seenTweets=new Set,this.seenMediaTweets=new Set,this.state={tweets:0,images:0,videos:0}}async waitForNext(t){if(!t)return null;if(await s(400),!t.nextElementSibling)return null;for(;d(this.progressQuery,t.nextElementSibling);)await s(i);return t.nextElementSibling}async expandMore(t){const e=d(this.expandQuery,t);if(!e)return t;const a=t.previousElementSibling;for(e.click(),await s(i);d(this.progressQuery,a.nextElementSibling);)await s(i);return t=a.nextElementSibling}async*infScroll(){let t=d(this.rootPath);if(!t)return;let e=t.firstElementChild;if(e)for(;e;){let t=d(this.anchorQuery,e);if(!t&&this.expandQuery&&(e=await this.expandMore(e,this.expandQuery,this.progressQuery),t=d(this.anchorQuery,e)),e&&e.innerText&&e.scrollIntoView(),e&&t){await s(i);const a=new h(this.childMatchSelect,e);a.matchValue&&(yield t,e=await a.restore(this.rootPath,this.childMatch))}e=await this.waitForNext(e,this.progressQuery)}}async*mediaPlaying(t){const e=d("(.//video | .//audio)",t);if(!e||e.paused)return;let i="Waiting for media playback";try{const e=new URL(u(this.childMatchSelect,t.parentElement),window.location.origin).href;if(this.seenMediaTweets.has(e))return;i+=" for "+e,this.seenMediaTweets.add(e)}catch(t){console.warn(t)}i+=" to finish...",yield this.getState(i,"videos");const a=new Promise((t=>{e.addEventListener("ended",(()=>t())),e.addEventListener("abort",(()=>t())),e.addEventListener("error",(()=>t())),e.addEventListener("pause",(()=>t()))}));await Promise.race([a,s(6e4)])}async*iterTimeline(t=0){if(!this.seenTweets.has(window.location.href)){yield this.getState("Capturing thread: "+window.location.href,"threads");for await(const e of this.infScroll()){if(d(this.promoted,e))continue;await s(500),yield*this.clickImages(e,t);const i=d(this.quoteQuery,e);i&&(yield*this.clickTweet(i,1e3)),yield*this.mediaPlaying(e),yield*this.clickTweet(e,t),await s(1e3)}}}async*clickImages(t){const e=d(this.imageQuery,t);if(e){const t=new c((()=>e.click()));yield this.getState("Loading Image: "+window.location.href,"images"),await s(1e3);let i=null,a=window.location.href;for(;null!=(i=d(this.imageNextQuery));){if(i.click(),await s(400),window.location.href===a){await s(1e3);break}a=window.location.href,yield this.getState("Loading Image: "+window.location.href,"images"),await s(1e3)}await t.goBack(this.imageCloseQuery)}}async*clickTweet(t,e){const a=new c((()=>t.click()));await s(i),a.changed&&(yield this.getState("Capturing Tweet: "+window.location.href,"tweets"),e<this.maxDepth&&!this.seenTweets.has(window.location.href)&&(yield*this.iterTimeline(e+1,this.maxDepth)),this.seenTweets.add(window.location.href),await s(400),await a.goBack(this.backButtonQuery),await s(i))}async*[Symbol.asyncIterator](){yield*this.iterTimeline(0)}}const x=[v,b];e=class{constructor(){this.behaviors=[],this.mainBehavior=null,this.inited=!1,this.started=!1,n("Loaded behaviors for: "+self.location.href)}init(t={autofetch:!0,autoplay:!0,autoscroll:!0,siteSpecific:!0}){if(this.inited)return;if(this.inited=!0,!self.window)return;if(this.timeout=t.timeout,void 0!==t.log){let e=t.log;"string"==typeof e&&(e=self[e]),"function"==typeof e?r(e):!1===e&&r(null)}t.autofetch&&(n("Enable AutoFetcher"),this.behaviors.push(new g)),t.autoplay&&(n("Enable Autoplay"),this.behaviors.push(new y));let e=!1;if(self.window.top===self.window){if(t.siteSpecific)for(const t of x)if(t.isMatch()){n("Starting Site-Specific Behavior: "+t.name),this.mainBehaviorClass=t,this.mainBehavior=new t,e=!0;break}!e&&t.autoscroll&&(n("Starting Autoscroll"),this.mainBehaviorClass=S,this.mainBehavior=new S),this.mainBehavior&&this.behaviors.push(this.mainBehavior)}}async run(t){if(this.started)return void this.unpause();this.init(t),await o(),this.mainBehavior&&this.mainBehavior.start(),this.started=!0;let e=Promise.allSettled(this.behaviors.map((t=>t.done())));this.timeout?(n(`Waiting for behaviors to finish or ${this.timeout}ms timeout`),e=Promise.race([e,s(this.timeout)])):n("Waiting for behaviors to finish"),await e,n("All Behaviors Done!"),this.mainBehavior&&this.mainBehaviorClass.cleanup&&this.mainBehavior.cleanup()}pause(){n("Pausing Main Behavior"+this.mainBehaviorClass.name),this.mainBehavior&&this.mainBehavior.pause()}unpause(){n("Unpausing Main Behavior: "+this.mainBehaviorClass.name),this.mainBehavior&&this.mainBehavior.unpause()}},l(self)})();